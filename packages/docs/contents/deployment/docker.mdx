---
title: Docker
description: é€šè¿‡ Docker éƒ¨ç½² Afilmory çš„æŒ‡å—
createdAt: 2025-07-20T22:35:03+08:00
lastModified: 2025-09-18T00:47:02+08:00
---

# Docker éƒ¨ç½²

![Docker éƒ¨ç½²](/static/docker-deploy.webp)

## å¿«é€Ÿæ‘˜è¦

Fork https://github.com/Afilmory/docker   è‡ªå®šä¹‰é…ç½®å¹¶æ„å»ºé•œåƒã€‚

### è¯´æ˜

è¯¥æ•™ç¨‹ä¼šéƒ¨ç½²[Afilmory/afilmory](https://github.com/Afilmory/afilmory)çš„ä»£ç ï¼Œè€Œå¹¶éæœ¬ç«™ï¼Œè‹¥è¦éƒ¨ç½²æœ¬ç«™ï¼Œæ¨èæŸ¥çœ‹å…¶ä»–æ–¹å¼éƒ¨ç½²

## ğŸš€ å¿«é€Ÿå¼€å§‹

ä½¿ç”¨ Docker éƒ¨ç½² Afilmory æ˜¯ä¸€ç§ä¾¿æ·é«˜æ•ˆçš„æ–¹å¼æ¥ç®¡ç†æ‚¨çš„ç…§ç‰‡ç”»å»Šåº”ç”¨ã€‚æœ¬æŒ‡å—å°†å¼•å¯¼æ‚¨å®Œæˆä½¿ç”¨ Docker è®¾ç½®å’Œè¿è¡Œ Afilmory çš„æ­¥éª¤ã€‚

### å‰ææ¡ä»¶

- Docker
- Docker Composeï¼ˆå¯é€‰ä½†æ¨èï¼‰
- PostgreSQL æ•°æ®åº“ï¼ˆç”¨äº SSR åº”ç”¨ï¼‰

### 1. é…ç½®æ–‡ä»¶

åœ¨æ„å»º Docker é•œåƒä¹‹å‰ï¼Œæ‚¨éœ€è¦é…ç½®ä»¥ä¸‹æ–‡ä»¶ï¼š

**`config.json`**

```json
{
  "name": "æ‚¨çš„ç…§ç‰‡ç”»å»Š",
  "title": "æ‚¨çš„ç…§ç‰‡ç”»å»Š", 
  "description": "æ•æ‰ç”Ÿæ´»ä¸­çš„ç¾å¥½ç¬é—´",
  "url": "https://your-domain.com",
  "accentColor": "#fb7185",
  "author": {
    "name": "æ‚¨çš„åå­—",
    "url": "https://your-website.com",
    "avatar": "https://your-avatar-url.com/avatar.png"
  },
  "social": {
    "twitter": "@yourusername"
  },
  "extra": {
    "accessRepo": true
  }
}
```

**`builder.config.json`**

```json
{
  "repo": {
    "enable": false,
    "url": "https://github.com/username/gallery-public"
  },
  "storage": {
    "provider": "s3",
    "bucket": "your-photos-bucket",
    "region": "us-east-1",
    "prefix": "photos/",
    "customDomain": "cdn.yourdomain.com"
  },
  "performance": {
    "worker": {
      "enabled": true,
      "maxWorkers": 4
    }
  }
}
```

**`.env`**

```bash
# æ•°æ®åº“é…ç½®
PG_CONNECTION_STRING=postgresql://user:password@postgres:5432/afilmory

# S3 å­˜å‚¨é…ç½®
S3_ACCESS_KEY_ID=your_access_key_id
S3_SECRET_ACCESS_KEY=your_secret_access_key

# Git ä»“åº“ï¼ˆå¯é€‰ï¼‰
GIT_TOKEN=your_github_token

# åº”ç”¨è®¾ç½®
NODE_ENV=production
PORT=3000
```

### 2. Dockerfile è®¾ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `Dockerfile` æ–‡ä»¶ï¼š

```dockerfile
# ç”¨äº pnpm å•ä½“ä»“åº“ä¸­ Next.js åº”ç”¨çš„ Dockerfile
# æ­¤ Dockerfile åº”ä»å•ä½“ä»“åº“çš„æ ¹ç›®å½•æ„å»ºï¼š
# > docker build -t iris-ssr .
# > docker run -p 3000:3000 iris-ssr

# -----------------
# åŸºç¡€é˜¶æ®µ
# -----------------
FROM node:20-alpine AS base
WORKDIR /app
RUN corepack enable

# -----------------
# æ„å»ºé˜¶æ®µ
# -----------------
FROM base AS builder

RUN apk update && apk add --no-cache git perl

RUN git clone https://github.com/Afilmory/Afilmory --depth 1 .
COPY config.json ./
COPY builder.config.json ./
COPY .env ./

ARG S3_ACCESS_KEY_ID
ARG S3_SECRET_ACCESS_KEY
ARG GIT_TOKEN
ARG PG_CONNECTION_STRING

RUN sh ./scripts/preinstall.sh
# å®‰è£…æ‰€æœ‰ä¾èµ–
RUN pnpm install --frozen-lockfile

# æ„å»ºåº”ç”¨ã€‚
# ssr package.json ä¸­çš„æ„å»ºè„šæœ¬é¦–å…ˆå¤„ç†æ„å»º web åº”ç”¨ã€‚
RUN pnpm --filter=@afilmory/ssr build

# -----------------
# è¿è¡Œé˜¶æ®µ
# -----------------
FROM base AS runner

WORKDIR /app

ENV NODE_ENV=production
# ENV PORT å’Œå…¶ä»–é…ç½®ç°åœ¨ä½äºé…ç½®æ–‡ä»¶ä¸­
# å¹¶åœ¨è¿è¡Œæ—¶é€šè¿‡ç¯å¢ƒå˜é‡ä¼ é€’ã€‚
RUN apk add --no-cache curl wget
# åˆ›å»ºé root ç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs
RUN adduser --system --uid 1001 nextjs

USER nextjs

COPY --from=builder --chown=nextjs:nodejs /app/apps/ssr/.next/standalone ./
COPY --from=builder --chown=nextjs:nodejs /app/apps/ssr/.next/static /app/apps/ssr/.next/static
COPY --from=builder --chown=nextjs:nodejs /app/apps/ssr/public /app/apps/ssr/public

# ç‹¬ç«‹è¾“å‡ºåŒ…å« server.js æ–‡ä»¶ã€‚
# PORT ç¯å¢ƒå˜é‡ä¼šè¢« Next.js è‡ªåŠ¨ä½¿ç”¨ã€‚
EXPOSE 3000

CMD ["node", "apps/ssr/server.js"]
```

### 3. Docker Compose è®¾ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `docker-compose.yml` æ–‡ä»¶ï¼š

```yaml
version: '3.8'

services:
  afilmory:
    build: .
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
    volumes:
      - ./config.json:/app/config.json:ro
      - ./builder.config.json:/app/builder.config.json:ro
      - ./.env:/app/.env:ro
    depends_on:
      - postgres
    restart: unless-stopped

  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: afilmory
      POSTGRES_USER: afilmory
      POSTGRES_PASSWORD: your_secure_password
    volumes:
      - postgres_data:/var/lib/postgresql/data
    restart: unless-stopped

volumes:
  postgres_data:
```

### 4. æ„å»ºå’Œè¿è¡Œ

#### é€‰é¡¹ 1ï¼šä½¿ç”¨ Docker Composeï¼ˆæ¨èï¼‰

```bash
# æ„å»ºå¹¶å¯åŠ¨æ‰€æœ‰æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f afilmory

# åœæ­¢æœåŠ¡
docker-compose down
```

#### é€‰é¡¹ 2ï¼šæ‰‹åŠ¨ Docker æ„å»º

```bash
# æ„å»ºé•œåƒ
docker build -t afilmory .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name afilmory \
  -p 3000:3000 \
  --env-file .env \
  -v $(pwd)/config.json:/app/config.json:ro \
  -v $(pwd)/builder.config.json:/app/builder.config.json:ro \
  afilmory
```

## ğŸ“‹ é…ç½®è¯¦æƒ…

### å­˜å‚¨æä¾›å•†

Afilmory æ”¯æŒå¤šç§å­˜å‚¨æä¾›å•†ã€‚åœ¨ `builder.config.json` ä¸­é…ç½®å®ƒä»¬ï¼š

**S3 å…¼å®¹å­˜å‚¨ï¼š**
```json
{
  "storage": {
    "provider": "s3",
    "bucket": "your-bucket",
    "region": "us-east-1",
    "prefix": "photos/",
    "customDomain": "cdn.example.com"
  }
}
```

**GitHub å­˜å‚¨ï¼š**
```json
{
  "storage": {
    "provider": "github",
    "owner": "username",
    "repo": "photo-storage",
    "branch": "main",
    "path": "photos/"
  }
}
```

